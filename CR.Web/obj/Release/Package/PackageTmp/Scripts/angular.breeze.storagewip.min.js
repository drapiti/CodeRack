(function(){"use strict";function t(n,t){function u(t,i,r){return n.$broadcast(t,{activity:i,wip:r||[]})}function f(n){if(!n)return n;try{var f=JSON.parse(n),t=f[0];if(t.breezeVersion===i.breezeVersion&&t.appVersion===i.appVersion)return t.isLoaded&&(i.isLoaded.sessions=i.isLoaded.sessions||t.isLoaded.sessions,i.isLoaded.attendees=i.isLoaded.attendees||t.isLoaded.attendees),f[1];u(r.events.error,"Did not load from lun because mismatched versions",{current:i,storage:t})}catch(e){u(r.events.error,"Exception during load from lun: "+e.message,e)}return null}function e(){for(var n in i.isLoaded)i.isLoaded.hasOwnProperty(n)&&(i.isLoaded[n]=!1)}function o(n,t){return"["+JSON.stringify(n)+","+t+"]"}var r=t.config,i={breezeVersion:breeze.version,appVersion:r.version,isLoaded:{sessions:!1,attendees:!1}};return{_broadcast:u,checkStoreImportVersionAndParseData:f,formatStorageData:o,clearAllIsLoadedFlags:e,storeMeta:i}}function i(n,t,i,r){function s(n){f=n}function h(n,t){return t===undefined?r.storeMeta.isLoaded[n]:r.storeMeta.isLoaded[n]=t}function c(){t.localStorage.clear();r.clearAllIsLoadedFlags();r._broadcast(u.events.wipChanged,"cleared all WIP");r._broadcast(u.events.storeChanged,"cleared")}function l(){return o?v():!1}function a(){if(o){var n=f.exportEntities();y(e,n);r._broadcast(u.events.storeChanged,"saved",n)}}function v(){var n=t.localStorage.getItem(e),i;return n=r.checkStoreImportVersionAndParseData(n),i=!!n,i&&f.importEntities(n),i}function y(n,i){t.localStorage.setItem(n,r.formatStorageData(r.storeMeta,i))}var u=i.config,f,e=u.key,o=u.enabled;return{areItemsLoaded:h,clear:c,init:s,load:l,save:a}}function r(n,t,i,r,u){function c(n){return s=n,h}function l(){var n=e();n.forEach(function(n){i.localStorage.removeItem(n.key)});u._broadcast(f.events.wipChanged,"cleared all WIP");i.localStorage.removeItem(o)}function a(n,t){var r=e(),i=r.filter(function(i){return i.entityName.toLowerCase()===n.toLowerCase()&&i.id===t})[0];return i?i.key:null}function e(){var n=[],t=i.localStorage.getItem(o);return t&&(n=JSON.parse(t)),n}function v(n){return w(n)}function y(n){if(n){i.localStorage.removeItem(n);var r=e(),t=r.filter(function(t){return t.key!==n});i.localStorage.setItem(o,JSON.stringify(t));u._broadcast(f.events.wipChanged,"removed 1 entity",t)}}function p(n,t,i,r,u){var e=f.appErrorPrefix,o,h,c;if(!n)throw new Error(e+"Must pass entity to storeWipEntity");if(!i)throw new Error(e+"Must pass entityName to storeWipEntity");if(!r)throw new Error(e+"Must pass description to storeWipEntity");return(u||(u=i.toLowerCase()),o=n.entityAspect.entityState,h=o.isAdded()||o.isModified(),!h)?t:(t||(t=f.newGuid()),c=s.exportEntities([n],!1),b(t,c),k(n,t,i,r,u),t)}function w(n){var t=i.localStorage.getItem(n),r,f,e;return(t=u.checkStoreImportVersionAndParseData(t),r=!!t,r)?(f=s.importEntities(t),e=f.entities[0],e):null}function b(n,t){var r={breezeVersion:u.storeMeta.breezeVersion,breezeMetadataVersion:u.storeMeta.breezeMetadataVersion,appVersion:u.storeMeta.appVersion};i.localStorage.setItem(n,u.formatStorageData(r,t))}function k(n,t,r,s,h){var l={id:n.id,date:new Date,key:t,routeState:h,state:n.entityAspect.entityState.name,entityName:r,description:s},c=e(),a=c.some(function(n){return n.key===l.key});a||(c.push(l),i.localStorage.setItem(o,JSON.stringify(c)));u._broadcast(f.events.wipChanged,"saved",c)}var f=r.config,s,o=f.wipKey,h={clearAllWip:l,findWipKeyByEntityId:a,init:c,getWipSummary:e,loadWipEntity:v,removeWipEntity:y,storeWipEntity:p};return h}var n=angular.module("ngzWip",[]);n.provider("zStorageConfig",function(){this.config={enabled:!1,key:"",events:{error:"store.error",storeChanged:"store.changed",wipChanged:"wip.changed"},wipKey:"",appErrorPrefix:"[ngzWip] ",newGuid:breeze.core.getUuid,version:""};this.$get=function(){return{config:this.config}}});n.factory("zStorageCore",["$rootScope","zStorageConfig",t]);n.factory("zStorage",["$rootScope","$window","zStorageConfig","zStorageCore",i]);n.factory("zStorageWip",["$q","$rootScope","$window","zStorageConfig","zStorageCore",r])})();
/*
//# sourceMappingURL=angular.breeze.storagewip.min.js.map
*/